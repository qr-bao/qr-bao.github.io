<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æœ¬èªæ–‡æ›¸ãƒ–ãƒ©ã‚¦ã‚¶</title>
    <style>
        /* åŸºæœ¬æ ·å¼é‡ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        /* æ·»åŠ æ–°ç« èŠ‚æŒ‰é’®æ ·å¼ */
        .add-section-button {
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            min-height: 150px;
            flex: 1;
            min-width: 280px;
            max-width: calc(50% - 20px);
            transition: background-color 0.3s;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .add-section-button:hover {
            background-color: #3d8b40;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }

        .add-section-button span {
            font-size: 32px;
            margin-right: 10px;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .modal h2 {
            margin-bottom: 20px;
            color: #1565c0;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 16px;
        }

        .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons button {
            padding: 10px 20px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }

        .modal-buttons .cancel-btn {
            background-color: #f5f5f5;
            color: #333;
        }

        .modal-buttons .save-btn {
            background-color: #4a90e2;
            color: white;
        }
        body {
            font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', Meiryo, sans-serif;
            line-height: 1.8;
            color: #333;
            background-color: #f5f5f5;
        }

        /* æŒ¯ã‚Šä»®åæ ·å¼ */
        ruby {
            ruby-align: center;
        }
        
        rt {
            font-size: 0.6em;
            color: #666;
            line-height: 1.2;
        }

        /* å®¹å™¨å¸ƒå±€ */
        .container {
            display: flex;
            min-height: 100vh;
        }

        /* ä¾§è¾¹æ æ ·å¼ */
        .sidebar {
            width: 720px;
            background-color: #fff;
            border-right: 1px solid #e0e0e0;
            padding: 20px;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* æœç´¢æ¡†æ ·å¼ */
        .search-container {
            display: flex;
            margin-bottom: 20px;
        }

        .search-container input {
            flex-grow: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px 0 0 4px;
            font-size: 14px;
        }

        .search-container button {
            background-color: #4a90e2;
            color: white;
            border: none;
            border-radius: 0 4px 4px 0;
            padding: 0 12px;
            cursor: pointer;
        }

        /* ç›®å½•æ ·å¼ */
        .toc {
            flex-grow: 1;
            overflow-y: auto;
        }

        .toc h2 {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            font-size: 18px;
        }

        .toc ul {
            list-style: none;
        }

        .toc li {
            margin-bottom: 10px;
        }

        .toc a {
            text-decoration: none;
            color: #333;
            display: block;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .toc a:hover {
            background-color: #f0f7ff;
        }

        .toc li.active a {
            background-color: #e3f2fd;
            color: #1565c0;
            font-weight: bold;
        }

        /* å†…å®¹åŒºåŸŸæ ·å¼ */
        .content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* å¡ç‰‡è§†å›¾æ ·å¼ */
        .card-view {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            width: 100%;
            padding: 0 15px;
            box-sizing: border-box;
            flex-grow: 1;
        }

        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            height: 100vh; /* ä¿®æ”¹ä¸º100vhï¼Œä½¿å¡ç‰‡é«˜åº¦ç­‰äºè§†å£é«˜åº¦ */
            flex: 1;
            min-width: 280px;
            max-width: calc(50% - 20px);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }

        .card-content {
            padding: 15px;
            flex-grow: 1;
            overflow-y: auto; /* å¯ç”¨å‚ç›´æ»šåŠ¨ */
            display: flex;
            flex-direction: column;
            /* æ·»åŠ è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 0, 0, 0.2) rgba(0, 0, 0, 0.05);
        }
        /* ä¸ºWebKitæµè§ˆå™¨(Chrome, Safari)æ·»åŠ è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        .card-content::-webkit-scrollbar {
            width: 6px;
        }

        .card-content::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        .card-content::-webkit-scrollbar-track {
            background-color: rgba(0, 0, 0, 0.05);
        }

        /* æ·»åŠ æ»šåŠ¨æç¤ºæ•ˆæœ */
        .card-content::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 20px;
            background: linear-gradient(to top, rgba(255, 255, 255, 0.9), transparent);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .card-content.scrollable::after {
            opacity: 1;
        }
        .card-content h3 {
            margin-bottom: 8px;
            color: #1565c0;
            font-size: 1.1em;
        }

        .card-content p {
            color: #666;
            font-size: 0.95em;
            line-height: 1.5;
            flex-grow: 1;
            margin: 0;
            overflow: visible;
            display: block;
            word-break: break-word;
        }

        .card-title {
            background-color: #f5f5f5;
            padding: 8px;
            text-align: center;
            font-weight: bold;
            border-top: 1px solid #eee;
            font-size: 0.95em;
        }

        /* è¯¦ç»†å†…å®¹è§†å›¾æ ·å¼ */
        .detail-view {
            display: none;
            max-width: 900px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .detail-view.active {
            display: block;
        }

        .detail-header {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background-color: #f5f5f5;
            border-bottom: 1px solid #eee;
        }

        .detail-header button {
            background-color: #4a90e2;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            cursor: pointer;
            margin-right: 20px;
        }

        .detail-header h2 {
            margin: 0;
            flex-grow: 1;
        }

        .detail-content {
            padding: 30px;
            line-height: 1.8;
        }

        .detail-content h2 {
            margin-bottom: 20px;
            color: #1565c0;
        }

        .detail-content h3 {
            margin: 25px 0 15px;
            color: #333;
        }

        .detail-content p {
            margin-bottom: 15px;
        }

        .detail-content ul, .detail-content ol {
            margin: 15px 0;
            padding-left: 25px;
        }

        .detail-content li {
            margin-bottom: 10px;
        }

        .detail-content pre {
            background-color: #f8f8f8;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 20px 0;
        }

        .detail-content code {
            font-family: 'Courier New', Courier, monospace;
        }

        /* æŒ¯å‡åæ§åˆ¶åŒºåŸŸæ ·å¼ */
        .furigana-control-panel {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .furigana-control-panel h3 {
            margin-bottom: 15px;
            font-size: 16px;
        }

        .option-group {
            margin-bottom: 10px;
        }

        .option-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .option-group input[type="checkbox"] {
            margin-right: 8px;
        }

        /* æŒ¯å‡åæ§åˆ¶åŒºåŸŸå†…ã®ãƒœã‚¿ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ */
        .furigana-controls {
            display: flex;
            flex-wrap: wrap; /* ãƒœã‚¿ãƒ³ãŒå…¥ã‚Šãã‚‰ãªã„å ´åˆã¯æŠ˜ã‚Šè¿”ã™ */
            gap: 10px; /* ãƒœã‚¿ãƒ³é–“ã®é–“éš” */
        }

        .furigana-controls button {
            background-color: #4a90e2;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            cursor: pointer;
            margin-right: 0; /* margin-rightã‚’0ã«å¤‰æ›´ã—ã€gapã§é–“éš”ã‚’å–ã‚‹ */
            margin-top: 0; /* margin-topã‚‚0ã«å¤‰æ›´ã—ã€gapã§é–“éš”ã‚’å–ã‚‹ */
            white-space: nowrap; /* ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®æŠ˜ã‚Šè¿”ã—ã‚’é˜²æ­¢ */
        }

        .furigana-controls button:hover {
            background-color: #3a76d8;
        }

        .furigana-controls button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .status {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        /* ç¼–è¾‘æŒ‰é’®æ ·å¼ */
        .edit-btn {
            background-color: #4a90e2;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            cursor: pointer;
            margin-left: 10px;
        }

        .edit-btn:hover {
            background-color: #3a76d8;
        }

        /* å†…å®¹ç¼–è¾‘çŠ¶æ€æ ·å¼ */
        .detail-content.editing {
            background-color: #f9f9ff;
            border: 1px solid #4a90e2;
            border-radius: 4px;
            padding: 15px;
            outline: none;
        }

        /* çŠ¶æ€æç¤ºæ ·å¼ */
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            font-size: 0.9em;
            text-align: center;
            transition: opacity 0.3s;
            opacity: 0;
        }

        .status.visible {
            opacity: 1;
        }

        .status.success {
            background-color: #e7f7e7;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }

        .status.error {
            background-color: #fdecea;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }

        .status.info {
            background-color: #e3f2fd;
            color: #1565c0;
            border: 1px solid #bbdefb;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (min-width: 1201px) {
            .card {
                max-width: calc(25% - 20px);
            }
        }
        
        @media (min-width: 901px) and (max-width: 1200px) {
            .card {
                max-width: calc(33.333% - 20px);
            }
        }
        
        @media (max-width: 900px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                min-height: auto; /* è¿½åŠ : ãƒ¢ãƒã‚¤ãƒ«ãƒ“ãƒ¥ãƒ¼ã§ã¯é«˜ã•ã‚’åˆ¶é™ã—ãªã„ */
                position: relative;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
                padding: 15px;
            }
            
            .sidebar .search-container,
            .sidebar .toc h2,
            .sidebar .furigana-control-panel h3 {
                margin-bottom: 10px;
            }
            
            .search-container input,
            .search-container button {
                height: 38px;
            }
            
            .toc li {
                margin-bottom: 5px;
            }
            
            .card-view {
                padding: 10px;
            }
            
            .card {
                max-width: calc(50% - 10px);
            }
            
            .card-content {
                padding: 12px;
            }
            
            .card-content h3 {
                font-size: 1em;
                margin-bottom: 5px;
            }
            
            .card-title {
                padding: 6px;
            }
            
            .detail-content {
                padding: 15px;
            }
        }
        
        @media (max-width: 600px) {
            .card {
                max-width: 100%;
            }
            
            .detail-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .detail-header button {
                margin-bottom: 10px;
                margin-right: 0;
            }
            
            .detail-header h2 {
                font-size: 1.2em;
            }
            
            .detail-content h2 {
                font-size: 1.3em;
            }
            
            .detail-content h3 {
                font-size: 1.1em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§ç›®å½•åŒºåŸŸ -->
        <aside class="sidebar">
            <div class="search-container">
                <input type="text" id="search-input" placeholder="æ–‡æ›¸ã‚’æ¤œç´¢...">
                <button id="search-button">ğŸ”</button>
            </div>
            <nav class="toc">
                <h2>ç›®æ¬¡</h2>
                <ul id="toc-list">
                    <li data-target="section1"><a href="#section1">ç¬¬ä¸€ç« ï¼šã¯ã˜ã‚ã«</a></li>
                    <li data-target="section2"><a href="#section2">ç¬¬äºŒç« ï¼šåŸºç¤æ¦‚å¿µ</a></li>
                    <li data-target="section3"><a href="#section3">ç¬¬ä¸‰ç« ï¼šå¿œç”¨æŠ€è¡“</a></li>
                    <li data-target="section4"><a href="#section4">ç¬¬å››ç« ï¼šå®Ÿè·µä¾‹</a></li>
                </ul>
            </nav>
            
            <!-- æŒ¯å‡åæ§åˆ¶åŒºåŸŸ -->
            <div class="furigana-control-panel">
                <h3>æŒ¯ã‚Šä»®åè¨­å®š</h3>
                <div class="option-group">
                    <label>
                        <input type="checkbox" id="use-hiragana" checked> 
                        å¹³ä»®åä½¿ç”¨ï¼ˆç‰‡ä»®åã‚ˆã‚Šï¼‰
                    </label>
                </div>
                <div class="option-group">
                    <label>
                        <input type="checkbox" id="annotate-all"> 
                        å…¨ã¦ã®å˜èªã‚’æ³¨é‡ˆ
                    </label>
                </div>
                <div class="furigana-controls">
                    <button id="apply-furigana">æŒ¯ã‚Šä»®åè¡¨ç¤º</button>
                    <button id="reset-furigana">åŸæ–‡è¡¨ç¤º</button>
                </div>
                <div class="status" id="mecab-status">MeCab: åˆæœŸåŒ–ä¸­...</div>
            </div>
        </aside>

        <!-- å³ä¾§å†…å®¹åŒºåŸŸ -->
        <main class="content">
            <!-- å¡ç‰‡é¢„è§ˆæ¨¡å¼ -->
            <div class="card-view" id="card-view">
                <div class="card" data-section="section1">
                    <div class="card-content">
                        <h3>ç¬¬ä¸€ç« ï¼šã¯ã˜ã‚ã«</h3>
                        <p>æ—¥æœ¬èªã®ãƒ†ã‚­ã‚¹ãƒˆã‚’èª­ã‚€ãŸã‚ã®ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚ã“ã®æ›¸é¡ã§ã¯ã€æ—¥æœ¬èªã®å­¦ç¿’ã«å½¹ç«‹ã¤æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚ã“ã®ç´¹ä»‹éƒ¨åˆ†ã«ã¯ã€ç›®çš„ã¨èƒŒæ™¯ã€å†…å®¹ã®æ¦‚è¦ãªã©ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚</p>
                    </div>
                    <div class="card-title">ã¯ã˜ã‚ã«</div>
                </div>
                <div class="card" data-section="section2">
                    <div class="card-content">
                        <h3>ç¬¬äºŒç« ï¼šåŸºç¤æ¦‚å¿µ</h3>
                        <p>ã“ã‚Œã¯ç¬¬äºŒç« ã®è©³ç´°å†…å®¹ã§ã™ã€‚ã“ã“ã§ã¯åŸºç¤æ¦‚å¿µã¨åŸç†ã‚’ç´¹ä»‹ã—ã¦ãŠã‚Šã€å¾Œè¨˜ç« ã‚’ç†è§£ã™ã‚‹ãŸã‚ã®åŸºç¤ã¨ãªã‚Šã¾ã™ã€‚åŸºç¤æ¦‚å¿µã«ã¯æ¦‚å¿µï¼‘ã¨æ¦‚å¿µï¼’ãŒå«ã¾ã‚Œã¾ã™ã€‚</p>
                    </div>
                    <div class="card-title">åŸºç¤æ¦‚å¿µ</div>
                </div>
                <div class="card" data-section="section3">
                    <div class="card-content">
                        <h3>ç¬¬ä¸‰ç« ï¼šå¿œç”¨æŠ€è¡“</h3>
                        <p>ã“ã‚Œã¯ç¬¬ä¸‰ç« ã®è©³ç´°å†…å®¹ã§ã™ã€‚ã“ã“ã§ã¯ã„ãã¤ã‹ã®å¿œç”¨æŠ€è¡“ã¨æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¦ã„ã¾ã™ã€‚å¿œç”¨æŠ€è¡“ã«ã¯ã€Œæœ€é©åŒ–æ–¹æ³•ã€ã¨ã€Œæ‹¡å¼µæ©Ÿèƒ½ã€ãªã©ãŒå«ã¾ã‚Œã¾ã™ã€‚</p>
                    </div>
                    <div class="card-title">å¿œç”¨æŠ€è¡“</div>
                </div>
                <div class="card" data-section="section4">
                    <div class="card-content">
                        <h3>ç¬¬å››ç« ï¼šå®Ÿè·µä¾‹</h3>
                        <p>ã“ã‚Œã¯ç¬¬å››ç« ã®è©³ç´°å†…å®¹ã§ã™ã€‚ã“ã“ã§ã¯å®Ÿéš›ã®äº‹ä¾‹ã‚’é€šã—ã¦ã€å‰ã«ç´¹ä»‹ã—ãŸæ¦‚å¿µã¨æŠ€è¡“ã®å¿œç”¨ã‚’ç¤ºã—ã¾ã™ã€‚ç°¡å˜ãªå¿œç”¨ä¾‹ã¨è¤‡é›‘ãªã‚·ã‚¹ãƒ†ãƒ ä¾‹ãŒå«ã¾ã‚Œã¾ã™ã€‚</p>
                    </div>
                    <div class="card-title">å®Ÿè·µä¾‹</div>
                </div>
                <button class="add-section-button" id="add-section-button">
                    <span>+</span> æ–°ã—ã„ç« ã‚’è¿½åŠ 
                </button>
            </div>
            
            <!-- è¯¦ç»†å†…å®¹è§†å›¾ (åˆå§‹éšè—) -->
            <div class="detail-view" id="detail-view">
                <div class="detail-header">
                    <button id="back-button">â† æˆ»ã‚‹</button>
                    <h2 id="detail-title">ç« ã®ã‚¿ã‚¤ãƒˆãƒ«</h2>
                    <button id="edit-btn" class="edit-btn">ç·¨é›†</button>
                    <button id="save-btn" class="edit-btn" style="display: none;">ä¿å­˜</button>
                    <button id="cancel-btn" class="edit-btn" style="display: none;">å–æ¶ˆ</button>
                </div>
                <div class="detail-content" id="detail-content">

                    <!-- è¯¦ç»†å†…å®¹å°†åŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
                </div>
                <div class="status" id="status"></div>
            </div>
        </main>
    </div>
    <!-- æ·»åŠ æ–°ç« èŠ‚çš„æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="add-section-modal">
        <div class="modal">
            <h2>æ–°ã—ã„ç« ã‚’è¿½åŠ </h2>
            <form id="add-section-form">
                <div class="form-group">
                    <label for="section-title">ç« ã®ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input type="text" id="section-title" placeholder="ä¾‹ï¼šç¬¬äº”ç« ï¼šå¿œç”¨æŠ€è¡“ã®é«˜åº¦åŒ–" required>
                </div>
                <div class="form-group">
                    <label for="section-content">ç« ã®å†…å®¹ (HTMLã‚¿ã‚°ä½¿ç”¨å¯èƒ½)</label>
                    <textarea id="section-content" placeholder="<p>ç« ã®å†…å®¹ã‚’ã“ã“ã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>" required></textarea>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="cancel-btn" id="modal-cancel-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="save-btn">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
    <!-- åŸå§‹å†…å®¹æ•°æ® -->
    <div id="content-data" style="display:none;">
        <div id="section1">
            <h2>ç¬¬ä¸€ç« ï¼šã¯ã˜ã‚ã«</h2>
            <p>æ—¥æœ¬èªã®ãƒ†ã‚­ã‚¹ãƒˆã‚’èª­ã‚€ãŸã‚ã®ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚ã“ã®æ›¸é¡ã§ã¯ã€æ—¥æœ¬èªã®å­¦ç¿’ã«å½¹ç«‹ã¤æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚</p>
            <p>ã“ã®ç´¹ä»‹éƒ¨åˆ†ã«ã¯ã€æ¬¡ã®ã‚ˆã†ãªå†…å®¹ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼š</p>
            <ul>
                <li>ç›®çš„ã¨èƒŒæ™¯</li>
                <li>ä¸»è¦å†…å®¹ã®æ¦‚è¦</li>
                <li>äºˆæƒ³ã•ã‚Œã‚‹èª­è€…</li>
                <li>ã“ã®æ›¸é¡ã®ä½¿ã„æ–¹</li>
            </ul>
            <p>ã“ã®éƒ¨åˆ†ã¯é•·æ–‡ã«ãªã‚‹ã“ã¨ãŒã‚ã‚Šã€å¤šãã®æ®µè½ã‚„ç¯€ãŒå«ã¾ã‚Œã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚</p>
        </div>
        <div id="section2">
            <h2>ç¬¬äºŒç« ï¼šåŸºç¤æ¦‚å¿µ</h2>
            <p>ã“ã‚Œã¯ç¬¬äºŒç« ã®è©³ç´°å†…å®¹ã§ã™ã€‚ã“ã“ã§ã¯åŸºç¤æ¦‚å¿µã¨åŸç†ã‚’ç´¹ä»‹ã—ã¦ãŠã‚Šã€å¾Œè¨˜ç« ã‚’ç†è§£ã™ã‚‹ãŸã‚ã®åŸºç¤ã¨ãªã‚Šã¾ã™ã€‚</p>
            <p>åŸºç¤æ¦‚å¿µã«ã¯æ¬¡ã®ã‚‚ã®ãŒå«ã¾ã‚Œã¾ã™ï¼š</p>
            <ol>
                <li>
                    <h3>æ¦‚å¿µï¼‘</h3>
                    <p>æ¦‚å¿µï¼‘ã«ã¤ã„ã¦ã®è©³ç´°ãªèª¬æ˜ã€‚ã“ã®æ¦‚å¿µã¯å…¨ä½“ä½“ç³»ã‚’ç†è§£ã™ã‚‹ãŸã‚ã®åŸºç¤ã§ã™ã€‚</p>
                </li>
                <li>
                    <h3>æ¦‚å¿µï¼’</h3>
                    <p>æ¦‚å¿µï¼’ã«ã¤ã„ã¦ã®è©³ç´°ãªèª¬æ˜ã€‚ã“ã®æ¦‚å¿µã¯æ¦‚å¿µï¼‘ã®åŸºç¤ã®ä¸Šã«æ§‹ç¯‰ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
                </li>
            </ol>
            <p>ã“ã‚Œã‚‰ã®åŸºç¤æ¦‚å¿µã‚’ç†è§£ã—ãŸå¾Œã€ã‚ˆã‚Šè¤‡é›‘ãªå¿œç”¨æŠ€è¡“ã«é€²ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
        </div>
        <div id="section3">
            <h2>ç¬¬ä¸‰ç« ï¼šå¿œç”¨æŠ€è¡“</h2>
            <p>ã“ã‚Œã¯ç¬¬ä¸‰ç« ã®è©³ç´°å†…å®¹ã§ã™ã€‚ã“ã“ã§ã¯ã„ãã¤ã‹ã®å¿œç”¨æŠ€è¡“ã¨æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¦ã„ã¾ã™ã€‚</p>
            <p>å¿œç”¨æŠ€è¡“ã«ã¯ä¸»ã«æ¬¡ã®ã‚ˆã†ãªå´é¢ãŒå«ã¾ã‚Œã¾ã™ï¼š</p>
            <h3>æŠ€è¡“ï¼‘ï¼šæœ€é©åŒ–æ–¹æ³•</h3>
            <p>ã“ã®éƒ¨åˆ†ã§ã¯æœ€é©åŒ–æ–¹æ³•ã®åŸç†ã¨å¿œç”¨ã«ã¤ã„ã¦è©³ç´°ã«ç´¹ä»‹ã—ã¦ã„ã¾ã™ã€‚</p>
            <p>æœ€é©åŒ–æ–¹æ³•ã¯æ¬¡ã®ã‚ˆã†ãªå´é¢ã‹ã‚‰è¡Œã†ã“ã¨ãŒã§ãã¾ã™ï¼š</p>
            <ul>
                <li>ç©ºé–“æœ€é©åŒ–</li>
                <li>æ™‚é–“æœ€é©åŒ–</li>
                <li>è³‡æºåˆ©ç”¨æœ€é©åŒ–</li>
            </ul>
            <h3>æŠ€è¡“ï¼’ï¼šæ‹¡å¼µæ©Ÿèƒ½</h3>
            <p>ã“ã®éƒ¨åˆ†ã§ã¯ã‚·ã‚¹ãƒ†ãƒ æ©Ÿèƒ½ã‚’æ‹¡å¼µã—ã€ã‚ˆã‚Šè¤‡é›‘ãªå¿œç”¨å ´é¢ã«é©å¿œã•ã›ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¦ã„ã¾ã™ã€‚</p>
        </div>
        <div id="section4">
            <h2>ç¬¬å››ç« ï¼šå®Ÿè·µä¾‹</h2>
            <p>ã“ã‚Œã¯ç¬¬å››ç« ã®è©³ç´°å†…å®¹ã§ã™ã€‚ã“ã“ã§ã¯å®Ÿéš›ã®äº‹ä¾‹ã‚’é€šã—ã¦ã€å‰ã«ç´¹ä»‹ã—ãŸæ¦‚å¿µã¨æŠ€è¡“ã®å¿œç”¨ã‚’ç¤ºã—ã¾ã™ã€‚</p>
            <h3>äº‹ä¾‹ï¼‘ï¼šç°¡å˜ãªå¿œç”¨</h3>
            <p>ã“ã®äº‹ä¾‹ã¯åŸºç¤æ¦‚å¿µã‚’ç°¡å˜ãªå ´é¢ã§å¿œç”¨ã™ã‚‹æ–¹æ³•ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚</p>
            <pre><code>// ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰
function ã‚Œã„() {
    console.log("ã“ã‚Œã¯ã‚µãƒ³ãƒ—ãƒ«é–¢æ•°ã§ã™");
    return "ã‚µãƒ³ãƒ—ãƒ«çµæœ";
}</code></pre>
            <h3>äº‹ä¾‹ï¼’ï¼šè¤‡é›‘ãªã‚·ã‚¹ãƒ†ãƒ </h3>
            <p>ã“ã®äº‹ä¾‹ã§ã¯è¤‡é›‘ãªã‚·ã‚¹ãƒ†ãƒ ã§æ§˜ã€…ãªæŠ€è¡“ã‚’å¿œç”¨ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¦ã„ã¾ã™ã€‚</p>
        </div>
    </div>

    <script type="module">
        import Mecab from "https://unpkg.com/mecab-wasm@1.0.2/lib/mecab.js";
        
        document.addEventListener('DOMContentLoaded', function() {
        // DOMå…ƒç´ 
        const cardView = document.getElementById('card-view');
        const detailView = document.getElementById('detail-view');
        const detailTitle = document.getElementById('detail-title');
        const detailContent = document.getElementById('detail-content');
        const backButton = document.getElementById('back-button');
        const useHiraganaCheckbox = document.getElementById('use-hiragana');
        const annotateAllCheckbox = document.getElementById('annotate-all');
        const applyFuriganaButton = document.getElementById('apply-furigana');
        const resetFuriganaButton = document.getElementById('reset-furigana');
        const mecabStatusElement = document.getElementById('mecab-status');
        // ç¼–è¾‘ç›¸å…³çš„DOMå…ƒç´ 
        const editButton = document.getElementById('edit-btn');
        const saveButton = document.getElementById('save-btn');
        const cancelButton = document.getElementById('cancel-btn');
        const statusElement = document.getElementById('status');
        // æœç´¢ç›¸å…³çš„DOMå…ƒç´ 
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        // æ·»åŠ æ–°ç« èŠ‚ç›¸å…³å…ƒç´ 
        const addSectionButton = document.getElementById('add-section-button');
        const addSectionModal = document.getElementById('add-section-modal');
        const addSectionForm = document.getElementById('add-section-form');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const sectionTitleInput = document.getElementById('section-title');
        const sectionContentInput = document.getElementById('section-content');
        const tocList = document.getElementById('toc-list');
        const contentDataDiv = document.getElementById('content-data');
        
            // åˆå§‹åŒ–ç°æœ‰å¡ç‰‡çš„æ»šåŠ¨æŒ‡ç¤ºå™¨
            document.querySelectorAll('.card-content').forEach(cardContent => {
                if (cardContent.scrollHeight > cardContent.clientHeight) {
                    cardContent.classList.add('scrollable');
                }
            });
            // å­˜å‚¨ç¼–è¾‘å‰çš„å†…å®¹
            let beforeEditContent = '';

            // å­˜å‚¨ä¿®æ”¹åçš„å†…å®¹
            const modifiedContent = {};

            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½ä¿®æ”¹å†…å®¹
            function loadModifiedContent() {
                try {
                    const saved = localStorage.getItem('modifiedSections');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        
                        // éå†æ‰€æœ‰ä¿å­˜çš„å†…å®¹ï¼Œç¡®ä¿ä¸åŒ…å«æŒ¯å‡åæ ‡ç­¾
                        for (const id in parsed) {
                            // æ¸…ç†å¯èƒ½å­˜åœ¨çš„æŒ¯å‡åæ ‡ç­¾
                            const cleanContent = removeRubyTags(parsed[id]);
                            
                            // æ›´æ–°åŸå§‹å†…å®¹å¯¹è±¡
                            originalContent[id] = cleanContent;
                            modifiedContent[id] = cleanContent;
                            
                            // é‡ç½®å¯¹åº”çš„å¤„ç†å†…å®¹ï¼Œè¿™æ ·ä¼šåœ¨ä¸‹æ¬¡æ˜¾ç¤ºæ—¶é‡æ–°å¤„ç†
                            delete processedContent[id];
                            
                            // æ›´æ–°é¢„è§ˆå¡ç‰‡ - æ·»åŠ è¿™ä¸€è¡Œ
                            updateCardPreview(id, cleanContent);
                        }
                        
                        // é‡æ–°ä¿å­˜å¹²å‡€çš„å†…å®¹
                        localStorage.setItem('modifiedSections', JSON.stringify(modifiedContent));
                    }
                } catch (error) {
                    console.error("åŠ è½½ä¿®æ”¹å†…å®¹é”™è¯¯:", error);
                }
            }
                        // å­˜å‚¨å½“å‰ç« èŠ‚ID
            let currentSectionId = null;
            
            // å­˜å‚¨åŸå§‹ç« èŠ‚å†…å®¹å’Œå·²å¤„ç†å†…å®¹
            const originalContent = {};
            const processedContent = {};
            document.querySelectorAll('#content-data > div').forEach(div => {
                originalContent[div.id] = div.innerHTML;
            });
            
            // MeCabåˆå§‹åŒ–çŠ¶æ€
            let mecabReady = false;
            // é»˜è®¤å¯ç”¨æŒ¯å‡å
            let furiganaEnabled = true;
            async function preprocessSection(sectionId) {
                if (!originalContent[sectionId] || !mecabReady) return;
                
                const useHiragana = useHiraganaCheckbox.checked;
                const annotateAll = annotateAllCheckbox.checked;
                
                // åˆ›å»ºä¸´æ—¶DOMå…ƒç´ æ¥å¤„ç†HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = originalContent[sectionId];
                
                // è·å–æ–‡æœ¬èŠ‚ç‚¹
                const textNodes = getTextNodes(tempDiv);
                
                // å¤„ç†æ¯ä¸ªæ–‡æœ¬èŠ‚ç‚¹
                for (const node of textNodes) {
                    const text = node.nodeValue.trim();
                    if (text) {
                        try {
                            // ä½¿ç”¨MeCabåˆ†ææ–‡æœ¬
                            const analysisResults = Mecab.query(text);
                            
                            // ç”Ÿæˆå¸¦æŒ¯å‡åçš„HTML
                            const html = generateFuriganaHTML(analysisResults, useHiragana, annotateAll);
                            
                            // åˆ›å»ºä¸´æ—¶å…ƒç´ 
                            const span = document.createElement('span');
                            span.innerHTML = html;
                            
                            // æ›¿æ¢æ–‡æœ¬èŠ‚ç‚¹
                            node.parentNode.replaceChild(span, node);
                        } catch (error) {
                            console.error("é¢„å¤„ç†ä¸­åˆ†æé”™è¯¯:", error, "æ–‡æœ¬:", text);
                        }
                    }
                }
                
                // ä¿å­˜å¤„ç†åçš„å†…å®¹
                processedContent[sectionId] = tempDiv.innerHTML;
            }
            // åˆå§‹åŒ–MeCab
            async function initMeCab() {
                mecabStatusElement.textContent = "MeCab: åŠ è½½ä¸­...";
                applyFuriganaButton.disabled = true;
                
                try {
                    // ç­‰å¾…MeCabåˆå§‹åŒ–å®Œæˆ
                    await Mecab.waitReady();
                    mecabReady = true;
                    mecabStatusElement.textContent = "MeCab: å‡†å¤‡å®Œæˆ";
                    applyFuriganaButton.disabled = false;
                    
                    // MeCabå‡†å¤‡å¥½åï¼Œé¢„å¤„ç†æ‰€æœ‰ç« èŠ‚çš„å†…å®¹
                    await preprocessAllSections();
                } catch (error) {
                    mecabStatusElement.textContent = "MeCab: åŠ è½½å¤±è´¥ - " + error.message;
                    console.error("MeCabåˆå§‹åŒ–é”™è¯¯:", error);
                }
            }
            
            // é¢„å¤„ç†æ‰€æœ‰ç« èŠ‚å†…å®¹ï¼Œæ·»åŠ æŒ¯å‡å
            // é¢„å¤„ç†æ‰€æœ‰ç« èŠ‚å†…å®¹ï¼Œæ·»åŠ æŒ¯å‡å
            async function preprocessAllSections() {
                mecabStatusElement.textContent = "MeCab: æ­£åœ¨é¢„å¤„ç†å†…å®¹...";
                
                const useHiragana = useHiraganaCheckbox.checked;
                const annotateAll = annotateAllCheckbox.checked;
                
                // å¤„ç†æ¯ä¸ªç« èŠ‚
                for (const sectionId in originalContent) {
                    // åˆ›å»ºä¸´æ—¶DOMå…ƒç´ æ¥å¤„ç†HTML
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = originalContent[sectionId];
                    
                    // è·å–æ–‡æœ¬èŠ‚ç‚¹
                    const textNodes = getTextNodes(tempDiv);
                    
                    // å¤„ç†æ¯ä¸ªæ–‡æœ¬èŠ‚ç‚¹
                    for (const node of textNodes) {
                        const text = node.nodeValue.trim();
                        if (text) {
                            try {
                                // ä½¿ç”¨MeCabåˆ†ææ–‡æœ¬
                                const analysisResults = Mecab.query(text);
                                
                                // ç”Ÿæˆå¸¦æŒ¯å‡åçš„HTML
                                const html = generateFuriganaHTML(analysisResults, useHiragana, annotateAll);
                                
                                // åˆ›å»ºä¸´æ—¶å…ƒç´ 
                                const span = document.createElement('span');
                                span.innerHTML = html;
                                
                                // æ›¿æ¢æ–‡æœ¬èŠ‚ç‚¹
                                node.parentNode.replaceChild(span, node);
                            } catch (error) {
                                console.error("é¢„å¤„ç†ä¸­åˆ†æé”™è¯¯:", error, "æ–‡æœ¬:", text);
                            }
                        }
                    }
                    
                    // ä¿å­˜å¤„ç†åçš„å†…å®¹
                    processedContent[sectionId] = tempDiv.innerHTML;
                }
                
                mecabStatusElement.textContent = "MeCab: å†…å®¹é¢„å¤„ç†å®Œæˆ";
            }
            // æ·»åŠ æ–°ç« èŠ‚æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            addSectionButton.addEventListener('click', function() {
                // é‡ç½®è¡¨å•
                addSectionForm.reset();
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                addSectionModal.classList.add('active');
            });
            // è¡¨å•æäº¤äº‹ä»¶
            addSectionForm.addEventListener('submit', function(event) {
                event.preventDefault();
                
                // è·å–è¡¨å•æ•°æ®
                const title = sectionTitleInput.value.trim();
                let content = sectionContentInput.value.trim();
                
                // å¦‚æœå†…å®¹ä¸­æ²¡æœ‰åŒ…å«h2æ ‡é¢˜ï¼Œåˆ™è‡ªåŠ¨æ·»åŠ 
                if (!content.includes('<h2>')) {
                    content = `<h2>${title}</h2>\n${content}`;
                }
                
                // ç”Ÿæˆå”¯ä¸€ID
                const timestamp = new Date().getTime();
                const sectionId = `section${timestamp}`;
                
                // æ›´æ–°ç›®å½•
                const liElement = document.createElement('li');
                liElement.setAttribute('data-target', sectionId);
                liElement.innerHTML = `<a href="#${sectionId}">${title}</a>`;
                tocList.appendChild(liElement);
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬
                liElement.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetSectionId = this.getAttribute('data-target');
                    showSection(targetSectionId);
                    
                    // é«˜äº®å½“å‰ç›®å½•é¡¹
                    document.querySelectorAll('#toc-list li').forEach(function(li) {
                        li.classList.remove('active');
                    });
                    this.classList.add('active');
                });
                
                // æ·»åŠ æ–°çš„å†…å®¹åŒºåŸŸ
                const sectionDiv = document.createElement('div');
                sectionDiv.id = sectionId;
                sectionDiv.innerHTML = content;
                contentDataDiv.appendChild(sectionDiv);
                
                // å°†æ–°å†…å®¹æ·»åŠ åˆ°åŸå§‹å†…å®¹å¯¹è±¡ä¸­
                originalContent[sectionId] = content;
                
                // åˆ›å»ºæ–°å¡ç‰‡
                createCardForSection(sectionId, content);
                
                // å¦‚æœæŒ¯å‡ååŠŸèƒ½å·²å¯ç”¨ï¼Œåˆ™å¤„ç†æ–°å†…å®¹
                if (mecabReady) {
                    preprocessSection(sectionId).then(() => {
                        console.log('æ–°ç« èŠ‚æŒ¯å‡åå¤„ç†å®Œæˆ');
                    });
                }
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                try {
                    modifiedContent[sectionId] = content;
                    localStorage.setItem('modifiedSections', JSON.stringify(modifiedContent));
                } catch (error) {
                    console.error("ä¿å­˜æ–°ç« èŠ‚å†…å®¹é”™è¯¯:", error);
                    showStatus("å†…å®¹ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ", "error");
                }
                
                // å…³é—­æ¨¡æ€æ¡†
                addSectionModal.classList.remove('active');
                
                // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
                showStatus("æ–°ã—ã„ç« ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ", "success");
            });
            // æ¨¡æ€æ¡†å–æ¶ˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            modalCancelBtn.addEventListener('click', function() {
                addSectionModal.classList.remove('active');
            });
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­æ¨¡æ€æ¡†
            addSectionModal.addEventListener('click', function(event) {
                if (event.target === addSectionModal) {
                    addSectionModal.classList.remove('active');
                }
            });
            // å¡ç‰‡ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.card').forEach(function(card) {
                card.addEventListener('click', function() {
                    const sectionId = this.getAttribute('data-section');
                    showSection(sectionId);
                });
            });
            
            // ç›®å½•é¡¹ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('#toc-list li').forEach(function(item) {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const sectionId = this.getAttribute('data-target');
                    showSection(sectionId);
                    
                    // é«˜äº®å½“å‰ç›®å½•é¡¹
                    document.querySelectorAll('#toc-list li').forEach(function(li) {
                        li.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            });
            // æ·»åŠ æœç´¢åŠŸèƒ½ - ç¡®ä¿æ­£ç¡®ç»‘å®šäº‹ä»¶
            searchButton.addEventListener('click', function() {
                console.log("æœç´¢æŒ‰é’®è¢«ç‚¹å‡»");  // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                performSearch();
            });

            // æ·»åŠ æœç´¢æ¡†å›è½¦é”®åŠŸèƒ½
            // æ·»åŠ æœç´¢æ¡†å›è½¦é”®åŠŸèƒ½
            searchInput.addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    performSearch();
                }
            });
            // è¿”å›æŒ‰é’®æ·»åŠ æ¸…é™¤æœç´¢åŠŸèƒ½
            // è¿”å›æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            backButton.addEventListener('click', function() {
                // ä¿®æ­£å‰: cardView.style.display = 'grid';
                // ä¿®æ­£å¾Œ: 'flex'ã«å¤‰æ›´ã—ã¦ã€flexãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ç¶­æŒ
                cardView.style.display = 'flex';
                detailView.classList.remove('active');
                
                // æ¸…é™¤ç›®å½•é¡¹é«˜äº®
                document.querySelectorAll('#toc-list li').forEach(function(li) {
                    li.classList.remove('active');
                });
                
                // æ¸…é™¤æœç´¢ï¼Œä»¥ä¾¿æ˜¾ç¤ºæ‰€æœ‰å¡ç‰‡
                clearSearch();
                
                currentSectionId = null;
            });
            // ç¼–è¾‘æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            editButton.addEventListener('click', function() {
                // ä¿å­˜å½“å‰å†…å®¹ï¼Œç”¨äºå–æ¶ˆæ“ä½œ
                beforeEditContent = detailContent.innerHTML;
                
                // å¯ç”¨ç¼–è¾‘æ¨¡å¼
                detailContent.contentEditable = true;
                detailContent.classList.add('editing');
                detailContent.focus();
                
                // åˆ‡æ¢æŒ‰é’®æ˜¾ç¤º
                editButton.style.display = 'none';
                saveButton.style.display = 'inline-block';
                cancelButton.style.display = 'inline-block';
                
                showStatus("ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ãŒã‚ªãƒ³ã«ãªã‚Šã¾ã—ãŸ", "info");
            });

            // ä¿å­˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            // ä¿å­˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            saveButton.addEventListener('click', async function() {
                // ç¦ç”¨ç¼–è¾‘æ¨¡å¼
                detailContent.contentEditable = false;
                detailContent.classList.remove('editing');
                
                // ä¿å­˜ä¿®æ”¹åçš„å†…å®¹
                if (currentSectionId) {
                    // ç§»é™¤æ‰€æœ‰æŒ¯ã‚Šä»®åæ ‡è®°ï¼Œä¿å­˜çº¯æ–‡æœ¬å†…å®¹
                    const cleanContent = removeRubyTags(detailContent.innerHTML);

                    // å°†ä¿®æ”¹åçš„å†…å®¹ä¿å­˜åˆ°åŸå§‹å†…å®¹å’Œä¿®æ”¹å†…å®¹å¯¹è±¡ä¸­
                    originalContent[currentSectionId] = cleanContent;
                    modifiedContent[currentSectionId] = cleanContent;
                    
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    try {
                        localStorage.setItem('modifiedSections', JSON.stringify(modifiedContent));
                    } catch (error) {
                        console.error("ä¿å­˜ä¿®æ”¹å†…å®¹é”™è¯¯:", error);
                        showStatus("å†…å®¹ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ", "error");
                        return;
                    }
                    
                    // æ¸…é™¤å¯¹åº”çš„å¤„ç†å†…å®¹ï¼Œåç»­ä¼šé‡æ–°å¤„ç†
                    delete processedContent[currentSectionId];
                    
                    // å¦‚æœæŒ¯å‡ååŠŸèƒ½å·²å¯ç”¨ï¼Œåˆ™é‡æ–°å¤„ç†å½“å‰å†…å®¹
                    if (furiganaEnabled && mecabReady) {
                        showStatus("ä¿å­˜ã—ã¾ã—ãŸã€‚æŒ¯ã‚Šä»®åã‚’å‡¦ç†ä¸­...", "info");
                        
                        await preprocessSection(currentSectionId);
                        
                        // æ˜¾ç¤ºå¤„ç†åçš„å†…å®¹
                        detailContent.innerHTML = processedContent[currentSectionId];
                        showStatus("å†…å®¹ãŒä¿å­˜ã•ã‚Œã€æŒ¯ã‚Šä»®åãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ", "success");
                    } else {
                        // å¦åˆ™æ˜¾ç¤ºçº¯æ–‡æœ¬å†…å®¹
                        detailContent.innerHTML = cleanContent;
                        showStatus("å†…å®¹ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸ", "success");
                    }
                    
                    // æ›´æ–°é¢„è§ˆå¡ç‰‡å†…å®¹
                    updateCardPreview(currentSectionId, cleanContent);
                }
                
                // åˆ‡æ¢æŒ‰é’®æ˜¾ç¤º
                editButton.style.display = 'inline-block';
                saveButton.style.display = 'none';
                cancelButton.style.display = 'none';
            });
            // å–æ¶ˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            cancelButton.addEventListener('click', function() {
                // æ¢å¤ç¼–è¾‘å‰çš„å†…å®¹
                detailContent.innerHTML = beforeEditContent;
                
                // ç¦ç”¨ç¼–è¾‘æ¨¡å¼
                detailContent.contentEditable = false;
                detailContent.classList.remove('editing');
                
                // åˆ‡æ¢æŒ‰é’®æ˜¾ç¤º
                editButton.style.display = 'inline-block';
                saveButton.style.display = 'none';
                cancelButton.style.display = 'none';
                
                showStatus("ç·¨é›†ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ", "info");
            });
            // åˆ›å»ºæ–°ç« èŠ‚çš„å¡ç‰‡
            function createCardForSection(sectionId, content) {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card';
                cardDiv.setAttribute('data-section', sectionId);
                
                // åˆ›å»ºå¡ç‰‡å†…å®¹
                cardDiv.innerHTML = `
                    <div class="card-content">
                        <h3>Loading...</h3>
                        <p>Loading...</p>
                    </div>
                    <div class="card-title">Loading...</div>
                `;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                cardDiv.addEventListener('click', function() {
                    const clickedSectionId = this.getAttribute('data-section');
                    showSection(clickedSectionId);
                });
                
                // æ’å…¥åˆ°æ·»åŠ æŒ‰é’®ä¹‹å‰
                cardView.insertBefore(cardDiv, addSectionButton);
                
                // æ›´æ–°å¡ç‰‡é¢„è§ˆ
                updateCardPreview(sectionId, content);
            }
            // æ–°å¢ï¼šæ›´æ–°é¢„è§ˆå¡ç‰‡çš„å‡½æ•°
            // æ–°å¢ï¼šæ›´æ–°é¢„è§ˆå¡ç‰‡çš„å‡½æ•°
            function updateCardPreview(sectionId, content) {
                // æŸ¥æ‰¾å¯¹åº”çš„å¡ç‰‡
                const card = document.querySelector(`.card[data-section="${sectionId}"]`);
                if (!card) {
                    console.error('æ‰¾ä¸åˆ°å¯¹åº”å¡ç‰‡:', sectionId);
                    return;
                }
                
                // è§£æå†…å®¹ï¼Œæå–æ ‡é¢˜å’Œæ‘˜è¦
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = content;
                
                // è·å–æ ‡é¢˜
                const h2 = tempDiv.querySelector('h2');
                if (h2) {
                    // æ›´æ–°å¡ç‰‡æ ‡é¢˜
                    const cardTitle = card.querySelector('.card-title');
                    if (cardTitle) {
                        const titleText = h2.textContent.replace(/^ç¬¬.*ç« ï¼š/, '');
                        console.log('æ›´æ–°å¡ç‰‡æ ‡é¢˜ä¸º:', titleText);
                        cardTitle.textContent = titleText;
                    }
                    
                    // æ›´æ–°å¡ç‰‡å†…å®¹æ ‡é¢˜
                    const cardContentTitle = card.querySelector('.card-content h3');
                    if (cardContentTitle) {
                        console.log('æ›´æ–°å¡ç‰‡å†…å®¹æ ‡é¢˜ä¸º:', h2.textContent);
                        cardContentTitle.textContent = h2.textContent;
                    }
                }
                
                // è·å–å¡ç‰‡å†…å®¹åŒºåŸŸçš„æ®µè½å…ƒç´ 
                const cardContentP = card.querySelector('.card-content p');
                if (!cardContentP) return;
                
                // æ¸…ç©ºç°æœ‰å†…å®¹
                cardContentP.innerHTML = '';
                
                // åˆ›å»ºä¸€ä¸ªæ–‡æ¡£ç‰‡æ®µæ¥å­˜å‚¨é¢„è§ˆå†…å®¹
                const fragment = document.createDocumentFragment();
                
                // è·å–æ‰€æœ‰æ®µè½å’Œå…¶ä»–å…ƒç´ 
                const contentNodes = Array.from(tempDiv.children).filter(node => node.tagName !== 'H2');
                
                // éå†å¹¶æ·»åŠ å†…å®¹å…ƒç´ ï¼Œä¿ç•™æ ¼å¼
                for (let i = 0; i < contentNodes.length; i++) {
                    const node = contentNodes[i];
                    
                    // å¤åˆ¶èŠ‚ç‚¹ä»¥ä¿ç•™æ ¼å¼
                    const clonedNode = node.cloneNode(true);
                    
                    // æ·»åŠ åˆ°æ–‡æ¡£ç‰‡æ®µ
                    fragment.appendChild(clonedNode);
                }
                
                // å°†å¤„ç†åçš„å†…å®¹æ·»åŠ åˆ°å¡ç‰‡
                cardContentP.appendChild(fragment);
                
                // æ£€æŸ¥å†…å®¹æ˜¯å¦éœ€è¦æ»šåŠ¨
                const cardContent = card.querySelector('.card-content');
                
                // ä½¿ç”¨setTimeoutç¡®ä¿DOMæ¸²æŸ“å®Œæˆåå†æ£€æŸ¥æ»šåŠ¨
                setTimeout(() => {
                    if (cardContent.scrollHeight > cardContent.clientHeight) {
                        cardContent.classList.add('scrollable');
                    } else {
                        cardContent.classList.remove('scrollable');
                    }
                }, 0);
                
                console.log('æ›´æ–°å¡ç‰‡é¢„è§ˆå®Œæˆ');
            }
            // æ‰§è¡Œæœç´¢
            function performSearch() {
                console.log("æ‰§è¡Œæœç´¢");  // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                const searchText = searchInput.value.trim().toLowerCase();
                console.log("æœç´¢æ–‡æœ¬:", searchText);  // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                
                if (!searchText) {
                    console.log("æœç´¢æ–‡æœ¬ä¸ºç©ºï¼Œæ˜¾ç¤ºæ‰€æœ‰å¡ç‰‡");  // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                    // å¦‚æœæœç´¢æ¡†ä¸ºç©ºï¼Œæ˜¾ç¤ºæ‰€æœ‰å¡ç‰‡
                    document.querySelectorAll('.card').forEach(card => {
                        card.style.display = 'flex';
                    });
                    return;
                }
                
                // åœ¨æ‰€æœ‰å†…å®¹ä¸­æœç´¢
                let foundResults = false;
                
                document.querySelectorAll('.card').forEach(card => {
                    const sectionId = card.getAttribute('data-section');
                    const content = originalContent[sectionId] || '';
                    
                    // åˆ›å»ºä¸€ä¸ªä¸´æ—¶DIVæ¥è§£æHTMLå†…å®¹å¹¶è·å–çº¯æ–‡æœ¬
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = content;
                    const textContent = tempDiv.textContent.toLowerCase();
                    
                    // æ£€æŸ¥å¡ç‰‡æ ‡é¢˜å’Œå†…å®¹æ˜¯å¦åŒ…å«æœç´¢æ–‡æœ¬
                    const cardTitle = card.querySelector('.card-title').textContent.toLowerCase();
                    const cardContentText = card.querySelector('.card-content').textContent.toLowerCase();
                    
                    if (textContent.includes(searchText) || 
                        cardTitle.includes(searchText) || 
                        cardContentText.includes(searchText)) {
                        card.style.display = 'flex';
                        foundResults = true;
                        console.log("æ‰¾åˆ°åŒ¹é…çš„å¡ç‰‡:", sectionId);  // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                    } else {
                        card.style.display = 'none';
                    }
                });
                
                // å¦‚æœåœ¨å¡ç‰‡è§†å›¾ï¼Œç¡®ä¿å¯è§
                if (detailView.classList.contains('active')) {
                    console.log("ä»è¯¦ç»†è§†å›¾è¿”å›åˆ°å¡ç‰‡è§†å›¾");  // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                    backButton.click(); // è¿”å›å¡ç‰‡è§†å›¾
                }
                
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç»“æœï¼Œæ˜¾ç¤ºæç¤º
                if (!foundResults) {
                    console.log("æœªæ‰¾åˆ°åŒ¹é…ç»“æœ");  // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                    showStatus("æ¤œç´¢çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ", "info");
                } else {
                    // å¦‚æœæ‰¾åˆ°ç»“æœï¼Œæ»šåŠ¨åˆ°é¡¶éƒ¨ä»¥ä¾¿æŸ¥çœ‹
                    window.scrollTo(0, 0);
                }
            }
            // æ¸…é™¤æœç´¢åŠŸèƒ½
            // æ¸…é™¤æœç´¢åŠŸèƒ½
            function clearSearch() {
                console.log("æ¸…é™¤æœç´¢");  // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                searchInput.value = '';
                document.querySelectorAll('.card').forEach(card => {
                    card.style.display = 'flex';
                });
            }
            // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
            function showStatus(message, type = "") {
                statusElement.textContent = message;
                statusElement.className = "status visible " + type;
                
                // 3ç§’åè‡ªåŠ¨æ¸…é™¤çŠ¶æ€
                setTimeout(() => {
                    statusElement.classList.remove('visible');
                }, 3000);
            }
            
            // åº”ç”¨æŒ¯å‡åæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            applyFuriganaButton.addEventListener('click', function() {
                if (!mecabReady) {
                    alert("MeCabå°šæœªå‡†å¤‡å¥½ï¼Œè¯·ç¨å€™");
                    return;
                }
                
                // å¯ç”¨æŒ¯å‡å
                furiganaEnabled = true;
                
                if (currentSectionId) {
                    // å¦‚æœå½“å‰æ­£åœ¨æŸ¥çœ‹ç« èŠ‚ï¼Œåˆ™åˆ‡æ¢åˆ°å¸¦å‡åç‰ˆæœ¬
                    if (processedContent[currentSectionId]) {
                        detailContent.innerHTML = processedContent[currentSectionId];
                        mecabStatusElement.textContent = "MeCab: å·²æ˜¾ç¤ºæŒ¯å‡å";
                    } else {
                        // å¦‚æœæ²¡æœ‰å¤„ç†è¿‡ï¼Œåˆ™å¤„ç†å½“å‰ç« èŠ‚
                        applyFuriganaToCurrentSection();
                    }
                } else {
                    mecabStatusElement.textContent = "MeCab: æŒ¯å‡åå·²å¯ç”¨ï¼Œè¯·é€‰æ‹©ç« èŠ‚";
                }
            });
            
            // é‡ç½®æŒ¯å‡åæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            resetFuriganaButton.addEventListener('click', function() {
                // ç¦ç”¨æŒ¯å‡å
                furiganaEnabled = false;
                
                if (currentSectionId) {
                    // æ˜¾ç¤ºåŸå§‹å†…å®¹
                    detailContent.innerHTML = originalContent[currentSectionId];
                    mecabStatusElement.textContent = "MeCab: å·²åˆ‡æ¢åˆ°åŸå§‹å†…å®¹";
                } else {
                    mecabStatusElement.textContent = "MeCab: æŒ¯å‡åå·²ç¦ç”¨ï¼Œè¯·é€‰æ‹©ç« èŠ‚";
                }
            });
            
            // æ˜¾ç¤ºç« èŠ‚å†…å®¹
            function showSection(sectionId) {
                const section = document.getElementById(sectionId);
                if (!section) {
                    console.error('æ‰¾ä¸åˆ°ç« èŠ‚:', sectionId);
                    return;
                }
                
                // ä¿å­˜å½“å‰ç« èŠ‚ID
                currentSectionId = sectionId;
                
                // è®¾ç½®æ ‡é¢˜
                detailTitle.textContent = section.querySelector('h2').textContent;
                
                // æ ¹æ®æŒ¯å‡åçŠ¶æ€å†³å®šæ˜¾ç¤ºå“ªä¸ªç‰ˆæœ¬çš„å†…å®¹
                if (furiganaEnabled && processedContent[sectionId]) {
                    // å¦‚æœå¯ç”¨æŒ¯å‡åå¹¶ä¸”æœ‰å¤„ç†åçš„å†…å®¹ï¼Œåˆ™ä½¿ç”¨å¤„ç†åçš„å†…å®¹
                    detailContent.innerHTML = processedContent[sectionId];
                } else {
                    // å¦åˆ™ä½¿ç”¨åŸå§‹å†…å®¹
                    detailContent.innerHTML = originalContent[sectionId];
                }
                
                // æ˜¾ç¤ºè¯¦ç»†è§†å›¾ï¼Œéšè—å¡ç‰‡è§†å›¾
                cardView.style.display = 'none';
                detailView.style.display = 'block';
                detailView.classList.add('active');
                
                // æ»šåŠ¨åˆ°é¡¶éƒ¨
                window.scrollTo(0, 0);
            }
            
            // å°†ç« èŠ‚å†…å®¹åº”ç”¨æŒ¯å‡å
            // å°†ç« èŠ‚å†…å®¹åº”ç”¨æŒ¯å‡å
            function applyFuriganaToCurrentSection() {
                if (!currentSectionId || !mecabReady) return;
                
                // é‡è¦ï¼šå…ˆé‡ç½®ä¸ºåŸå§‹å†…å®¹ï¼Œé˜²æ­¢é‡å¤åº”ç”¨æŒ¯å‡å
                detailContent.innerHTML = originalContent[currentSectionId];
                
                const useHiragana = useHiraganaCheckbox.checked;
                const annotateAll = annotateAllCheckbox.checked;
                
                // è·å–æ–‡æœ¬å†…å®¹
                const textNodes = getTextNodes(detailContent);
                
                // éå†æ–‡æœ¬èŠ‚ç‚¹
                textNodes.forEach(node => {
                    const text = node.nodeValue.trim();
                    if (text) {
                        try {
                            // ä½¿ç”¨MeCabåˆ†ææ–‡æœ¬
                            const analysisResults = Mecab.query(text);
                            
                            // ç”Ÿæˆå¸¦æŒ¯å‡åçš„HTML
                            const html = generateFuriganaHTML(analysisResults, useHiragana, annotateAll);
                            
                            // åˆ›å»ºä¸´æ—¶å…ƒç´ 
                            const span = document.createElement('span');
                            span.innerHTML = html;
                            
                            // æ›¿æ¢æ–‡æœ¬èŠ‚ç‚¹
                            node.parentNode.replaceChild(span, node);
                        } catch (error) {
                            console.error("åˆ†æé”™è¯¯:", error, "æ–‡æœ¬:", text);
                        }
                    }
                });
                
                // ä¿å­˜å¤„ç†åçš„å†…å®¹
                processedContent[currentSectionId] = detailContent.innerHTML;
                
                mecabStatusElement.textContent = "MeCab: æŒ¯å‡ååº”ç”¨å®Œæˆ";
            }
            // åŠ å¼ºremoveRubyTagså‡½æ•°ï¼Œç¡®ä¿å®Œå…¨æ¸…é™¤æ‰€æœ‰æŒ¯å‡åæ ‡ç­¾
            function removeRubyTags(html) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // å¾ªç¯ç§»é™¤æ‰€æœ‰rubyæ ‡ç­¾ç›´åˆ°æ²¡æœ‰ä»»ä½•rubyæ ‡ç­¾
                let rubyElements;
                while ((rubyElements = tempDiv.querySelectorAll('ruby')).length > 0) {
                    rubyElements.forEach(ruby => {
                        // è·å–ä¸»è¦æ–‡æœ¬å†…å®¹
                        let originalText = '';
                        for (const node of ruby.childNodes) {
                            if (node.nodeType === Node.TEXT_NODE) {
                                originalText += node.nodeValue;
                            } else if (node.nodeName !== 'RT' && node.nodeName !== 'RP') {
                                originalText += node.textContent;
                            }
                        }
                        
                        const textNode = document.createTextNode(originalText);
                        ruby.parentNode.replaceChild(textNode, ruby);
                    });
                }
                
                // ç§»é™¤æ‰€æœ‰å¯èƒ½æ®‹ç•™çš„rtå’Œrpæ ‡ç­¾
                tempDiv.querySelectorAll('rt, rp').forEach(node => node.remove());
                
                return tempDiv.innerHTML;
            }
            // è·å–å…ƒç´ ä¸­çš„æ–‡æœ¬èŠ‚ç‚¹
            // è·å–å…ƒç´ ä¸­çš„æ–‡æœ¬èŠ‚ç‚¹
            function getTextNodes(element) {
                const textNodes = [];
                const treeWalker = document.createTreeWalker(
                    element,
                    NodeFilter.SHOW_TEXT,
                    { acceptNode: function(node) { 
                        // æ£€æŸ¥è¯¥èŠ‚ç‚¹æˆ–å…¶ä»»ä½•ç¥–å…ˆæ˜¯å¦åœ¨rubyå…ƒç´ å†…
                        let parent = node.parentNode;
                        while (parent) {
                            if (parent.tagName === 'RUBY' || parent.tagName === 'RT' || 
                                parent.tagName === 'CODE') {
                                return NodeFilter.FILTER_REJECT;
                            }
                            parent = parent.parentNode;
                        }
                        
                        // æ’é™¤ç©ºæ–‡æœ¬
                        if (!node.nodeValue.trim()) {
                            return NodeFilter.FILTER_REJECT;
                        }
                        
                        return NodeFilter.FILTER_ACCEPT;
                    }},
                    false
                );
                
                let currentNode;
                while (currentNode = treeWalker.nextNode()) {
                    textNodes.push(currentNode);
                }
                
                return textNodes;
            }
            
            // ç”Ÿæˆå¸¦æŒ¯å‡åçš„HTML
            function generateFuriganaHTML(analysisResults, useHiragana, annotateAll) {
                if (!analysisResults || analysisResults.length === 0) {
                    return "";
                }
                
                let html = '';
                
                for (const token of analysisResults) {
                    // é€‚é…ä¸åŒçš„å±æ€§å
                    const surface = token.word || token.surface || "";
                    let reading = token.reading || "";
                    
                    // å¦‚æœæœ‰ç‰‡å‡åè¯»éŸ³ä¸”é€‰æ‹©äº†å¹³å‡åï¼Œåˆ™è½¬æ¢ä¸ºå¹³å‡å
                    if (reading && useHiragana) {
                        reading = katakanaToHiragana(reading);
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ æŒ¯å‡å
                    const hasKanji = /[\u4e00-\u9faf]/.test(surface);
                    const needsFurigana = (hasKanji || annotateAll) && reading && surface !== reading;
                    
                    // æ·»åŠ å¸¦æŒ¯å‡åçš„HTML
                    if (needsFurigana) {
                        html += "<ruby>" + surface + "<rt>" + reading + "</rt></ruby>";
                    } else {
                        html += surface;
                    }
                }
                
                return html;
            }
            
            // ç‰‡å‡åè½¬å¹³å‡å
            function katakanaToHiragana(str) {
                return str.replace(/[\u30a1-\u30f6]/g, function(match) {
                    const chr = match.charCodeAt(0) - 0x60;
                    return String.fromCharCode(chr);
                });
            }
            
            // æ£€æŸ¥é€‰é¡¹å˜æ›´å¹¶é‡æ–°å¤„ç†å†…å®¹
            useHiraganaCheckbox.addEventListener('change', async function() {
                if (mecabReady) {
                    // å½“é€‰é¡¹æ”¹å˜æ—¶ï¼Œé‡æ–°å¤„ç†æ‰€æœ‰å†…å®¹
                    await preprocessAllSections();
                    
                    // å¦‚æœå½“å‰åœ¨æŸ¥çœ‹ç« èŠ‚ä¸”æŒ¯å‡åå·²å¯ç”¨ï¼Œåˆ™æ›´æ–°æ˜¾ç¤º
                    if (currentSectionId && furiganaEnabled) {
                        detailContent.innerHTML = processedContent[currentSectionId];
                    }
                    
                    mecabStatusElement.textContent = "MeCab: å·²æ›´æ–°æŒ¯å‡åè®¾ç½®";
                }
            });
            
            annotateAllCheckbox.addEventListener('change', async function() {
                if (mecabReady) {
                    // å½“é€‰é¡¹æ”¹å˜æ—¶ï¼Œé‡æ–°å¤„ç†æ‰€æœ‰å†…å®¹
                    await preprocessAllSections();
                    
                    // å¦‚æœå½“å‰åœ¨æŸ¥çœ‹ç« èŠ‚ä¸”æŒ¯å‡åå·²å¯ç”¨ï¼Œåˆ™æ›´æ–°æ˜¾ç¤º
                    if (currentSectionId && furiganaEnabled) {
                        detailContent.innerHTML = processedContent[currentSectionId];
                    }
                    
                    mecabStatusElement.textContent = "MeCab: å·²æ›´æ–°æŒ¯å‡åè®¾ç½®";
                }
            });
            loadModifiedContent();
            // åˆå§‹åŒ–MeCab
            initMeCab();
        });
    </script>
</body>
</html>